{% extends "base.html" %}
{% load i18n %}
{% load Pleio_templatetags %}
{% load settings_value %}

{% block content %}

{% if messages %}
    {% if 'success' in message.tags %}
        <ul class="messages correct">
            {% for message in messages %}
            <li>
                {% include_asset "icons/check.svg" %}
                <div class="textcolor_primary">{% trans 'Success' %}</div>
                <div class="textcolor_secondary">{{ message }}</div>
            </li>
            {% endfor %}
        </ul>
    {% elif 'error' in message.tags %}
        <ul class="messages error">
            {% for message in messages %}
            <li>
                {% include_asset "icons/account-alert.svg" %}
                <div class="textcolor_primary">{% trans 'Error' %}</div>
                <div class="textcolor_secondary">{{ message }}</div>
            </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endif %}

<form method="post" action=".">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{next}}" />
    {% if login_step == 'login' %}
        <script type="text/javascript" src="{% url 'javascript-catalog' %}"></script>
        <div class="login__step-title">
            <div>
                {% if request.session.samlConnect %}
                    <h2>{% trans "Connect your existing Pleio-account" %}</h2>
                    <p>{% trans "with your Organisation-account" %}</p>
            {% else %}
                    <h2>{% trans "Sign in" %}</h2>
                    <p>{% trans "with your Pleio-account" %}</p>
                {% endif %}
            </div>
            <img src="/static/images/logo-icon.svg" class="login__step-icon"/>
        </div>

        <ul class="messages error">
                {% for error in form.non_field_errors %}
                <li>
                    {% include_asset "icons/account-alert.svg" %}
                    {% if error == 'captcha_mismatch' %}
                        <div class="textcolor_primary">{% trans "Login failed." %}</div>
                        <div class="textcolor_secondary">{% trans "Please check Google captcha." %}</div>
                    {% elif error == 'invalid_login' %}
                        <div class="textcolor_primary">{% trans "Please enter a correct email and password." %}</div>
                        <div class="textcolor_secondary">{% trans "Note that both fields may be case-sensitive." %}</div>
                    {% elif error == 'inactive' %}
                        <div class="textcolor_primary">{% trans "This account is inactive." %}</div>
                        <div class="textcolor_secondary">{% trans "Please check your email to validate your account." %}</div>
                    {% else %}
                        <div class="textcolor_primary">{% trans "Invalid login." %}</div>
                        <div class="textcolor_secondary">{{ error }}</div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <fieldset>
            <div class="input-field">
                <label for="id_auth-username">{% trans "Email address" %}</label>
                {{ form.errors.username }}
                {{ form.username }}
            </div>
            <div class="input-field">
                <label for="id_auth-password">{% trans "Password" %}</label>
                {{ form.errors.password }}
                {{ form.password }}
                <span class="password__toggle">{% include_asset "icons/eye.svg" %}</span>
                <a href="{% url 'password_reset' %}" class="forgot-password">{% trans "Forgot password" %}?</a>
                <p class="capslock"></p>
            </div>

            {% settings_value 'GOOGLE_RECAPTCHA_SITE_KEY' as recaptcha_site_key %}
            {% if recaptcha_site_key and reCAPTCHA %}
                <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
            {% endif %}

            <div class="login__buttons ___flexbuttons">
                <a href="{% url 'register' %}" class="button ___white ___outline">{% trans "Register account" %}</a>
                <button name="login" class="button ___active login__login" type="submit">{% trans "Login" %}</button>
            </div>
        </fieldset>
        <p></p>

    {% elif login_step == 'token' %}

    <div class="login__step-title">
        <div>
            <h2>{% trans "Sign in" %}</h2>
            <p>{% trans "with your Pleio-account" %}</p>
        </div>
        <img src="/static/images/logo-icon.svg" class="login__step-icon"/>
    </div>

    <ul class="messages error">
            {% for error in form.errors %}
            <li>
                {% include_asset "icons/account-alert.svg" %}
                <div class="textcolor_primary">{% trans "Invalid token." %}</div>
                <div class="textcolor_secondary">{% trans "Please make sure you have entered it correctly." %}</div>
            </li>
        {% endfor %}
    </ul>

    <ul class="messages info">
        <li class="messages__link">
            {% include_asset "icons/lock-plus.svg" %}
            <div class="textcolor_primary">{% trans "Two factor authentication" %}</div>
            <div class="textcolor_secondary">{% trans "Fill in a code from your code generator." %}</div>
        </li>
    </ul>

    <fieldset>
        <div class="input-field">
            {{ form.errors.otp_token }}
            {{ form.otp_token.label_tag }}
            {{ form.otp_token }}
        </div>
        <div class="login__buttons">
            <button class="button ___stretch ___active login__login" type="submit">{% trans "Login" %}</button>
            <a href="{% url 'login' login_step='login' %}" class="button ___stretch ___white ___outline">{% trans "Cancel" %}</a>
        </div>
    </fieldset>

    <div class="input-field">
        <a href="{% url 'login' login_step='backup' %}" class="button ___stretch ___white ___outline">{% trans "Use backuptoken" %}</a>
    </div>

    {% elif login_step == 'backup' %}

    <p>{% blocktrans %}Use this form for entering backup tokens for logging in.
         These tokens have been generated for you to print and keep safe. Please
             enter one of these backup tokens to login to your account.{% endblocktrans %}</p>
         <fieldset>

                <ul class="messages error">
                        {% for error in form.errors %}
                        <li>
                            {% include_asset "icons/account-alert.svg" %}
                            <div class="textcolor_primary">{% trans "Invalid token." %}</div>
                            <div class="textcolor_secondary">{% trans "Please make sure you have entered it correctly." %}</div>
                        </li>
                    {% endfor %}
                </ul>

            <div class="input-field">
                {{ form.errors.otp_token }}
                {{ form.otp_token.label_tag }}
                {{ form.otp_token }}
             </div>
         </fieldset>
        <div class="login__buttons">
            <button name="wizard_goto_step" type="submit" class="button ___stretch ___active">{% trans "Use backuptoken" %}</button>
            <a href="{% url 'login' login_step='token' %}" class="button ___stretch ___white ___outline">{% trans "Back" %}</a>
        </div>

    {% endif %}

</form>

{% if login_step == 'login' %}
    {% if request.session.samlConnect %}
    <form action="/saml/connect/">
        {% csrf_token %}
        <input type="hidden" name="sso" value="sso" />
        <div class="login__step-title">
            <div>
                <h2>{% trans "Auto-create new Pleio-account" %}</h2>
                <p>{% trans "based on your Organisation-account" %}</p>
            </div>
            <img src="/static/images/logo-icon.svg" class="login__step-icon"/>
        </div>
        <div class="login__buttons">
            <button name="login" class="button ___stretch ___active login__login" type="submit">{% trans "Connect" %}</button>
        </div>
    </form>
    {% else %}
        <form action="/saml/">
            {% csrf_token %}
            <input type="hidden" name="sso" value="sso" />
            <div class="login__step-title">
                <div>
                    <p>{% trans "of" %} {% trans "with your Organisation-account" %}</p>
                </div>
            </div>
            <fieldset>
              <div class="input-field">
                  <label for="idp">{% trans "Your organisation" %}</label>
                  <select name="idp" class="browser-default" onchange="this.form.submit()">
                  <option value="" selected disabled> </option>
                  {% for i in idps %}
                    <option value={{ i.shortname }}>{{ i.displayname }}</option>
                  {% endfor %}
                  </select>
              </div>
            </fieldset>
        </form>
    {% endif %}

    <ul class="messages info hide">
        <li class="messages__link">
            <a href="{% url 'security_pages' page_action='2fa-setup' %}">
                {% include_asset "icons/lock-plus.svg" %}
                <div class="textcolor_primary">{% trans "Secure your account" %}</div>
                <div class="textcolor_secondary">{% trans "Enable two factor authentication" %}</div>
            </a>
        </li>
    </ul>
{% endif %}


{% endblock %}
